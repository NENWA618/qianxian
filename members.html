<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>家族成员列表 - 千弦</title>
  
  <!-- 预加载关键资源 -->
  <link rel="preload" href="main.css" as="style">
  <link rel="preload" href="https://qianxian-backend.onrender.com/api/members" as="fetch" crossorigin="use-credentials">
  <link rel="preload" href="main.js" as="script">
  
  <!-- 资源链接 -->
  <link rel="icon" href="qianxian.png" type="image/png">
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <!-- 加载指示器 -->
  <div id="loading-indicator" aria-hidden="true">
    <div class="spinner" aria-label="加载中"></div>
  </div>

  <!-- 头部区域 -->
  <header class="logo-header">
    <a href="index.html" class="back-button" aria-label="返回首页">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
    </a>
    <img src="qianxian.png" alt="千弦 Logo" class="logo" loading="lazy" width="120" height="120">
    <h1>家族成员列表</h1>
  </header>

  <!-- 主要内容 -->
  <main>
    <div class="table-container">
      <table id="members-table" aria-describedby="table-description">
        <caption id="table-description" class="sr-only">千弦家族成员列表，包含ID、用户名和权限信息</caption>
        <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col">用户名</th>
            <th scope="col">权限</th>
            <th scope="col" id="th-action" style="display:none;">操作</th>
          </tr>
        </thead>
        <tbody id="members-tbody"></tbody>
      </table>
    </div>

    <!-- 成员详情面板 -->
    <div id="member-detail" class="detail-panel" aria-live="polite"></div>
  </main>

  <!-- 页脚 -->
  <footer>
    <p>© <span id="current-year"></span> 千弦家族 · 保留所有权利</p>
  </footer>

  <!-- 脚本加载 -->
  <script src="main.js" defer></script>

  <!-- 内联初始化脚本 -->
  <script>
    // 全局配置
    const API_BASE_URL = 'https://qianxian-backend.onrender.com';
    let currentUser = null;
    let csrfToken = null;

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // 显示加载状态
        document.getElementById('loading-indicator').style.display = 'flex';
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // 获取用户信息
        const userRes = await fetch(`${API_BASE_URL}/api/user`, {
          credentials: 'include'
        });
        
        if (userRes.ok) {
          const userData = await userRes.json();
          currentUser = userData.user || null;
          
          // 管理员显示操作列
          if (userData.isAuthenticated && currentUser?.is_admin) {
            document.getElementById('th-action').style.display = '';
          }
        }

        // 加载成员列表
        await loadMembers();
      } catch (error) {
        console.error('初始化失败:', error);
        alert('页面加载失败，请刷新重试');
      } finally {
        document.getElementById('loading-indicator').style.display = 'none';
      }
    });

    // 加载成员列表
    async function loadMembers() {
      try {
        const res = await fetch(`${API_BASE_URL}/api/members`, {
          credentials: 'include'
        });
        const data = await res.json();
        
        if (!data.success) throw new Error('获取成员列表失败');
        
        const tbody = document.getElementById('members-tbody');
        tbody.innerHTML = '';
        
        data.members.forEach(member => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${member.id}</td>
            <td>${escapeHtml(member.username)}</td>
            <td>${generateBadge(member)}</td>
          `;
          
          // 管理员操作列
          if (currentUser?.is_admin) {
            const btn = `<button onclick="showMemberDetail(${member.id})" class="view-btn">查看详情</button>`;
            tr.innerHTML += `<td>${btn}</td>`;
          }
          
          tbody.appendChild(tr);
        });
      } catch (error) {
        console.error('加载成员列表失败:', error);
        alert('加载成员列表失败，请刷新重试');
      }
    }

    // 生成权限徽章
    function generateBadge(member) {
      if (member.id === 1) {
        return `<span class="member-badge super-admin">创始人/超管</span>`;
      } else if (member.is_super_admin) {
        return `<span class="member-badge super-admin">超管</span>`;
      } else if (member.is_admin) {
        return `<span class="member-badge admin">管理员</span>`;
      }
      return `<span class="member-badge normal">普通成员</span>`;
    }

    // 查看成员详情
    window.showMemberDetail = async function(id) {
      try {
        const res = await fetch(`${API_BASE_URL}/api/members/${id}`, {
          credentials: 'include'
        });
        const data = await res.json();
        
        if (!data.success) throw new Error(data.message || '获取成员详情失败');
        
        const member = data.member;
        let html = `
          <div class="detail-content">
            <div class="member-badges">${generateBadge(member)}</div>
            <div class="detail-row"><span class="detail-label">ID:</span> ${member.id}</div>
            <div class="detail-row"><span class="detail-label">用户名:</span> ${escapeHtml(member.username)}</div>
            <div class="detail-row"><span class="detail-label">创建时间:</span> ${member.created_at}</div>
            <div class="detail-row"><span class="detail-label">管理员:</span> ${member.is_admin ? '是' : '否'}</div>
            <div class="detail-row"><span class="detail-label">超级管理员:</span> ${member.is_super_admin ? '是' : '否'}</div>
          </div>
        `;
        
        // 权限操作按钮
        if (currentUser && currentUser.id !== id) {
          html += `<div class="action-buttons">${generateActionButtons(member)}</div>`;
        }
        
        document.getElementById('member-detail').innerHTML = html;
      } catch (error) {
        document.getElementById('member-detail').innerHTML = `
          <div class="error-message">${error.message}</div>
        `;
      }
    }

    // 生成操作按钮
    function generateActionButtons(member) {
      let buttons = '';
      
      // 管理员操作（不能操作自己和创始人）
      if ((currentUser.id === 1 || currentUser.is_super_admin) && member.id !== 1) {
        buttons += `
          <button onclick="updateMemberRole(${member.id}, 'admin', ${!member.is_admin})" 
                  class="action-btn ${member.is_admin ? 'active' : ''}">
            ${member.is_admin ? '取消管理员' : '设为管理员'}
          </button>
          <span id="admin-msg-${member.id}" class="action-message"></span>
        `;
      }
      
      // 超级管理员操作（仅创始人）
      if (currentUser.id === 1 && member.id !== 1) {
        buttons += `
          <button onclick="updateMemberRole(${member.id}, 'super_admin', ${!member.is_super_admin})" 
                  class="action-btn ${member.is_super_admin ? 'active' : ''}">
            ${member.is_super_admin ? '取消超管' : '设为超管'}
          </button>
          <span id="super-admin-msg-${member.id}" class="action-message"></span>
        `;
      }
      
      return buttons;
    }

    // 更新成员角色
    window.updateMemberRole = async function(id, roleType, enable) {
      const msgElement = document.getElementById(`${roleType}-msg-${id}`);
      msgElement.textContent = '处理中...';
      msgElement.style.color = '#666';
      
      try {
        if (!csrfToken) {
          const tokenRes = await fetch(`${API_BASE_URL}/api/csrf-token`, {
            credentials: 'include'
          });
          const tokenData = await tokenRes.json();
          csrfToken = tokenData.token;
        }
        
        const endpoint = roleType === 'admin' 
          ? '/api/admin/set-admin' 
          : '/api/admin/set-super-admin';
        
        const res = await fetch(`${API_BASE_URL}${endpoint}`, {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify({
            userId: id,
            [roleType === 'admin' ? 'isAdmin' : 'isSuperAdmin']: enable
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          msgElement.textContent = '操作成功';
          msgElement.style.color = 'green';
          setTimeout(() => showMemberDetail(id), 800);
        } else {
          throw new Error(data.message || '操作失败');
        }
      } catch (error) {
        msgElement.textContent = error.message;
        msgElement.style.color = 'red';
      }
    }

    // XSS防护
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }
  </script>
</body>
</html>