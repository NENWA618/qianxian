<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>家族成员列表 - 千弦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="qianxian.png">
  <link rel="stylesheet" href="main.css">
  <style>
    .table-scroll-x {
      overflow-x: auto;
      width: 100%;
    }
    #members-table {
      width: 100%;
      min-width: 400px;
      border-collapse: collapse;
    }
    @media (max-width: 600px) {
      #members-table th, #members-table td {
        font-size: 0.98rem;
        padding: 0.6rem 0.2rem;
      }
      #member-detail {
        padding: 1rem 0.5rem;
        font-size: 1rem;
      }
    }
    @media (max-width: 480px) {
      #members-table th, #members-table td {
        font-size: 0.9rem;
        padding: 0.4rem 0.1rem;
      }
      #member-detail {
        padding: 0.7rem 0.2rem;
        font-size: 0.95rem;
      }
      .login-form button,
      #edit-home-content-panel button {
        width: 100%;
        margin-bottom: 0.5rem;
        font-size: 1rem;
        padding: 0.7rem 0;
      }
    }
    .add-friend-btn {
      background: #6abf69;
      color: #fff;
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      margin-left: 0.5rem;
      font-size: 0.98rem;
      position: relative;
    }
    .add-friend-btn[disabled] {
      background: #bdbdbd;
      cursor: not-allowed;
    }
    .friend-status {
      color: #6abf69;
      margin-left: 0.5rem;
      font-size: 0.95rem;
    }
    /* 红点样式：用于未读消息等 */
    .red-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      background: #e74c3c;
      border-radius: 50%;
      position: absolute;
      top: 0;
      right: 0;
      box-shadow: 0 0 2px #fff;
      border: 2px solid #fffbe9;
      z-index: 2;
    }
  </style>
</head>
<body>
  <header class="logo-header">
    <img src="qianxian.png" alt="千弦 Logo" class="logo">
    <h1>家族成员列表</h1>
    <!-- 通知中心入口按钮将由 main.js 动态插入到 admin-link 前 -->
    <div id="admin-link" style="text-align:right;margin:0.5rem 0;"></div>
  </header>
  <section class="about">
    <div class="table-scroll-x">
      <table id="members-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>用户名</th>
            <th>权限</th>
            <th>好友</th>
            <th id="th-action" style="display:none;">操作</th>
          </tr>
        </thead>
        <tbody id="members-tbody"></tbody>
      </table>
    </div>
    <div id="member-detail" style="margin-top:2rem;"></div>
  </section>
  <script>
    // 后端API基础地址
    const API_BASE_URL = 'https://qianxian-backend.onrender.com';

    // 当前用户信息
    let isAdmin = false;
    let currentUser = null;
    let friendsList = [];
    let isAuthenticated = false;
    let pendingRequests = []; // 新增：自己发出的好友申请

    // 全局缓存CSRF Token，页面只获取一次
    let csrfToken = null;
    let isFetchingToken = false;
    let tokenQueue = [];

    // 防XSS转义
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // 获取CSRF Token的增强函数（确保 session 初始化，支持并发队列）
    async function getCsrfToken(retryCount = 0) {
      const maxRetries = 3;
      const retryDelay = 1000;
      if (csrfToken) return csrfToken;
      if (isFetchingToken) {
        return new Promise(resolve => tokenQueue.push(resolve));
      }
      isFetchingToken = true;
      try {
        await fetch(API_BASE_URL + '/api/user', { credentials: 'include' });
        const res = await fetch(API_BASE_URL + '/api/csrf-token', {
          credentials: 'include',
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache'
          }
        });
        const data = await res.json();
        if (!data.token) throw new Error('获取CSRF令牌失败');
        csrfToken = data.token;
        while (tokenQueue.length > 0) {
          const resolve = tokenQueue.shift();
          resolve(csrfToken);
        }
        return csrfToken;
      } catch (err) {
        while (tokenQueue.length > 0) {
          const resolve = tokenQueue.shift();
          resolve(null);
        }
        if (retryCount < maxRetries - 1) {
          await new Promise(resolve => setTimeout(resolve, retryDelay));
          return getCsrfToken(retryCount + 1);
        }
        csrfToken = null;
        throw new Error('获取CSRF令牌失败');
      } finally {
        isFetchingToken = false;
      }
    }

    // 生成徽章HTML
    function getBadge(m) {
      if (m.id === 1) {
        return `<span class="member-badge super-admin">创始人/超管</span>`;
      } else if (m.is_super_admin) {
        return `<span class="member-badge super-admin">超管</span>`;
      } else if (m.is_admin) {
        return `<span class="member-badge admin">管理员</span>`;
      } else {
        return `<span class="member-badge normal">普通成员</span>`;
      }
    }

    // 获取当前用户信息并加载成员列表
    async function initMembersPage() {
      try {
        const res = await fetch(API_BASE_URL + '/api/user', {
          credentials: 'include'
        });
        const data = await res.json();
        currentUser = data.user || {};
        // 修改点：超管和管理员都能看到操作列
        isAdmin = data.isAuthenticated && data.user && (data.user.is_admin || data.user.is_super_admin);
        isAuthenticated = !!data.isAuthenticated;
        if (isAdmin) document.getElementById('th-action').style.display = '';
      } catch (e) {
        currentUser = {};
        isAdmin = false;
        isAuthenticated = false;
      }
      await loadFriends();
      await loadPendingRequests();
      loadMembers();
      renderNotificationCenterEntry();
    }

    // 加载好友列表
    async function loadFriends() {
      try {
        const res = await fetch(API_BASE_URL + '/api/friends', {
          credentials: 'include'
        });
        const data = await res.json();
        if (data.success) {
          friendsList = data.friends.map(f => f.id);
        } else {
          friendsList = [];
        }
      } catch (e) {
        friendsList = [];
      }
    }

    // 新增：加载自己发出的好友申请
    async function loadPendingRequests() {
      if (!isAuthenticated) {
        pendingRequests = [];
        return;
      }
      try {
        const token = await getCsrfToken();
        const res = await fetch(API_BASE_URL + '/api/friends/requests?type=sent', {
          credentials: 'include',
          headers: { 'X-CSRF-Token': token }
        });
        const data = await res.json();
        if (data.success) {
          pendingRequests = data.requests.map(r => r.to_user_id);
        } else {
          pendingRequests = [];
        }
      } catch (e) {
        pendingRequests = [];
      }
    }

    // 加载成员列表
    function loadMembers() {
      fetch(API_BASE_URL + '/api/members', {
        credentials: 'include'
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) throw new Error('获取成员列表失败');
        const tbody = document.getElementById('members-tbody');
        tbody.innerHTML = '';
        data.members.forEach(m => {
          if (currentUser && m.id === currentUser.id) {
            m.is_admin = currentUser.is_admin;
            m.is_super_admin = currentUser.is_super_admin;
          }
          const tr = document.createElement('tr');
          const badge = getBadge(m);

          // 好友按钮和状态
          let friendCell = '';
          if (
            isAuthenticated &&
            currentUser && m.id !== currentUser.id
          ) {
            if (friendsList.includes(m.id)) {
              friendCell = `<span class="friend-status">已是好友</span>`;
            } else if (pendingRequests.includes(m.id)) {
              friendCell = `<button class="add-friend-btn" disabled>等待同意</button>`;
            } else {
              friendCell = `<button class="add-friend-btn" onclick="addFriend(${m.id}, '${escapeHtml(m.username)}', this)">添加好友</button>`;
            }
          } else {
            friendCell = '';
          }

          tr.innerHTML = `<td>${m.id}</td><td>${escapeHtml(m.username)}</td><td>${badge}</td><td>${friendCell}</td>`;
          if (isAdmin) {
            const btn = `<button onclick="showDetail(${m.id})">查看详情</button>`;
            tr.innerHTML += `<td>${btn}</td>`;
          }
          tbody.appendChild(tr);
        });
      });
    }

    // 添加好友（改为发送好友申请）
    window.addFriend = async function(friendId, friendName, btn) {
      if (!confirm(`确定要添加 ${friendName} 为好友吗？`)) return;
      btn.disabled = true;
      btn.textContent = '申请中...';
      try {
        const token = await getCsrfToken();
        const res = await fetch(API_BASE_URL + '/api/friends/request', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': token
          },
          body: JSON.stringify({ toUserId: friendId })
        });
        const data = await res.json();
        if (data.success) {
          btn.textContent = '等待同意';
          btn.disabled = true;
        } else {
          btn.textContent = data.message || '申请失败';
          btn.disabled = false;
        }
        await loadPendingRequests();
        loadMembers();
      } catch (e) {
        btn.textContent = '申请失败';
        btn.disabled = false;
      }
    }

    // 查看成员详情并显示权限操作按钮
    window.showDetail = async function(id) {
      try {
        const res = await fetch(API_BASE_URL + '/api/members/' + id, {
          credentials: 'include'
        });
        const data = await res.json();
        if (!data.success) throw new Error('无权限或成员不存在');
        const m = data.member;
        const badge = getBadge(m);
        let html = `
          <div style="background:#fffbe9;padding:1rem;border-radius:8px;">
            <div class="member-badges" style="margin-bottom:0.5rem;">${badge}</div>
            <b>ID:</b> ${m.id}<br>
            <b>用户名:</b> ${escapeHtml(m.username)}<br>
            <b>创建时间:</b> ${escapeHtml(m.created_at)}<br>
            <b>是否管理员:</b> ${m.is_admin ? '是' : '否'}<br>
            <b>是否超管:</b> ${m.is_super_admin ? '是' : '否'}
          </div>
        `;

        // 权限按钮区域
        let btnHtml = '';
        const notSelf = currentUser && m.id !== currentUser.id;

        // 赋予/取消管理员按钮（创始人和超管都能操作，不能操作自己和创始人）
        if (
          notSelf &&
          (currentUser.id === 1 || currentUser.is_super_admin) &&
          m.id !== 1
        ) {
          btnHtml += `
            <button onclick="setAdmin(${m.id}, ${!m.is_admin})" style="background:#c2a469;color:#fff;border:none;padding:0.5rem 1.2rem;border-radius:8px;cursor:pointer;margin-right:1rem;">
              ${m.is_admin ? '取消管理员' : '赋予管理员'}
            </button>
            <span id="admin-msg"></span>
          `;
        }

        // 赋予/取消超管按钮（仅创始人可见，不能操作自己）
        if (currentUser && currentUser.id === 1 && m.id !== 1) {
          btnHtml += `
            <button onclick="setSuperAdmin(${m.id}, ${!m.is_super_admin})" style="background:#c2a469;color:#fff;border:none;padding:0.5rem 1.2rem;border-radius:8px;cursor:pointer;">
              ${m.is_super_admin ? '取消超管' : '赋予超管'}
            </button>
            <span id="super-admin-msg"></span>
          `;
        }

        if (btnHtml) {
          html += `<div style="margin-top:1rem;">${btnHtml}</div>`;
        }

        document.getElementById('member-detail').innerHTML = html;
      } catch (err) {
        document.getElementById('member-detail').textContent = err.message;
      }
    }

    // 赋予/取消管理员
    window.setAdmin = async function(userId, isAdmin) {
      const msg = document.getElementById('admin-msg');
      msg.textContent = '操作中...';
      try {
        const token = await getCsrfToken();
        const res = await fetch(API_BASE_URL + '/api/admin/set-admin', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': token
          },
          body: JSON.stringify({ userId, isAdmin })
        });
        const data = await res.json();
        msg.textContent = data.success ? '操作成功' : (data.message || '操作失败');
        msg.style.color = data.success ? 'green' : 'red';
        if (data.success) setTimeout(() => showDetail(userId), 800);
      } catch (e) {
        msg.textContent = '操作失败';
        msg.style.color = 'red';
      }
    }

    // 赋予/取消超管（仅创始人）
    window.setSuperAdmin = async function(userId, isSuperAdmin) {
      const msg = document.getElementById('super-admin-msg');
      msg.textContent = '操作中...';
      try {
        const token = await getCsrfToken();
        const res = await fetch(API_BASE_URL + '/api/admin/set-super-admin', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': token
          },
          body: JSON.stringify({ userId, isSuperAdmin })
        });
        const data = await res.json();
        msg.textContent = data.success ? '操作成功' : (data.message || '操作失败');
        msg.style.color = data.success ? 'green' : 'red';
        if (data.success) setTimeout(() => showDetail(userId), 800);
      } catch (e) {
        msg.textContent = '操作失败';
        msg.style.color = 'red';
      }
    }

    // =================== 通知中心入口与红点 ===================
    // 仅插入口，具体逻辑由 main.js 统一管理
    function renderNotificationCenterEntry() {
      let entry = document.getElementById('notification-center-entry');
      const adminLink = document.getElementById('admin-link');
      if (!currentUser) {
        if (entry) entry.remove();
        return;
      }
      if (!entry) {
        entry = document.createElement('button');
        entry.id = 'notification-center-entry';
        entry.className = 'add-friend-btn';
        entry.style = 'margin-right:1rem;position:relative;';
        entry.innerHTML = `<span style="vertical-align:middle;">消息中心</span><span id="notification-red-dot" class="red-dot" style="display:none;position:absolute;top:4px;right:2px;"></span>`;
        if (adminLink && adminLink.parentNode) {
          adminLink.parentNode.insertBefore(entry, adminLink);
        } else {
          document.body.appendChild(entry);
        }
        // 事件绑定交由 main.js 处理
      }
    }
    // =================== END 通知中心入口与红点 ===================

    // 页面初始化
    document.addEventListener('DOMContentLoaded', initMembersPage);
  </script>
</body>
</html>